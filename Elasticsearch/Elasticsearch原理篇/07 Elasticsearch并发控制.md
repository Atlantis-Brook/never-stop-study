#es #elasticsearch
# 1. 悲观锁
对于一个共享数据，某个线程访问到这个数据的时候，会认为这个数据随时有可能会被其他线程访问而造成数据不安全的情况，因此线程在每次访问的时候都会对数据加一把锁。这样其他线程如果在加锁期间想访问当前数据就只能等待，也就是阻塞线程了。
# 2. 乐观锁
乐观锁的并不是真的加了一把锁。乐观锁机制表示线程在每次操作数据的时候，都乐观的认为不会有其他线程来会来操作当前数据，因此不加锁。但是乐观锁在每次更新数据的时候都会通过比对**版本号**来检查当前数据是不是被其他线程修改过。如果没有，则正常修改数据并且更新数据版本号，否则，仅更新自身版本号。
# 3. 如何选择
- 首先，乐观锁和悲观锁没有孰优孰劣，它们各自有各自的适用场景。
- 在并发写入数量较少的情况，乐观锁因为没有真正的去上锁，从而避免频繁的上锁、释放锁带来的性能开销，故而提升了吞吐性能。
- 在并发写入数量较大的情况，线程之间的竞争激烈，就会导致线程频繁的尝试，每次尝试都要进行版本号比对，尝试失败还要更新自身携带的版本号，这样反复尝试积累的性能损耗可能已经超过了使用直接加锁然后将线程挂起而带来的性能损耗，此时使用悲观锁更加合适。
# 4.乐观锁并发控制
Elasticsearch 是分布式的。创建、更新或删除文档时，必须将文档的新版本复制到集群中的其他节点。ES 也是异步并行的，所以这些复制请求是并行发送的，并且可能不按顺序执行到每个节点。ES 需要一种并发策略来保证数据的安全性，这种策略就是乐观锁并发控制策略。
为了保证旧文档不会被新文档所覆盖，对文档执行的每个操作都由协调该更改的主分片分配一个序列号(\_seq\_no)。每个操作都会操作序列号递增，因此可以保证较新的操作具有更高的序列号。然后，ES 可以使用操作的序列号确保更新的文档版本永远不会被较小序列号的版本所覆盖。

## 4.1 版本号：\_version
### 基本原理

![image.png](https://atlantis-picgo-core.oss-cn-beijing.aliyuncs.com/picgo/20250815120232-32b363-20250815120231865.png)
### 作用范围

### 版本类型
- `external`或者`external_gt`
  仅当给定版本严格高于存储文档的版本**或**不存在现有文档时才索引文档。给定版本将用作新版本，并将与新文档一起存储。提供的版本必须是非负长整数。
- `external_gte`
  仅当给定版本**等于**或高于存储文档的版本时才索引文档。如果没有现有文档，则操作也会成功。给定版本将用作新版本，并将与新文档一起存储。提供的版本必须是非负长整数。
`external_gte` 需要谨慎使用，否则可能会丢失数据。