# 一、问题及影响范围：
## 问题
（1） [#274688 客服工作台卡死](https://ones.edianzu.cn/project/#/team/FkhuaHWU/project/C4H8kcDJQeeGfuVv/component/qSy2kWTP/task/Jt2mE2ycRH5SrnNa)
（2）业务群反馈
![](https://alidocs.dingtalk.com/core/api/resources/img/5eecdaf48460cde5f0589c192356a7671c70a8b201b3b05a75b8339e1c4c2483d3ee942809d4d88a39e8703ac5556d0df3ba4f2c20bcab6277885bee0c6ca77f0b00b8a293cb38ccbcff21f5de3175cf5292d8bded89d9d17b37795f142cc77c?tmpCode=bac90d62-1e0b-480e-a1b3-d8ac85626a3b)

（3）业务群反馈
![](https://alidocs.dingtalk.com/core/api/resources/img/5eecdaf48460cde5f0589c192356a7671c70a8b201b3b05a75b8339e1c4c2483d3ee942809d4d88a39e8703ac5556d0d2e44929ca617798a9fa8217eff794ebc9d169e97bff4e6b08195e924729c4a1468ef08598063690bc39b360b823e6e34?tmpCode=bac90d62-1e0b-480e-a1b3-d8ac85626a3b)

## 影响范围：
admin服务的`https://adminnew.edianzu.cn/api/site/checkLoginByToken?ssId=15e1359222a6d8b9cf2de517a33b67f3`接口报错，导致admin登陆后身份认证失败。所有接入admin的系统均受影响

## 二、时间线：
2025年9月28日：
1. admin代码上线（22:14 群里反馈admin登陆问题）
2. 怀疑28日的代码变更存在bug，@梁强(破天)(梁强)立即回滚当晚上线的代码（22:16）。
3. 回滚后发现问题依然没有得到解决。（22:24）
4. 根据报错发现数据库格式问题，经查找，定位通过数据库连接增加`zeroDateTimeBehavior=convertToNull`（22:28）
5. 定位nacos，发现nacos中数据连接配置问题（22:30）。
6. 更改nacos配置，重启上线（22：38 admin恢复正常）
## 三、问题原因：

问题1：
nacos配置错误导致（数据库连接配置多打了个换行符）
- 报错提示  
  ![image.png](https://atlantis-picgo-core.oss-cn-beijing.aliyuncs.com/picgo/20251010110207-5d9f63-20251010110206931.png)
  ![Uploading file...gv99w]()

    ![](https://alidocs.dingtalk.com/core/api/resources/img/5eecdaf48460cde5f0589c192356a7671c70a8b201b3b05a75b8339e1c4c2483d3ee942809d4d88a39e8703ac5556d0dfaa633852b22888719ed7e54685638f885a13a15433f83ab3b3fca0fb97a90d133994b7f4988fa432f402d485b7e54ac?tmpCode=cfb4505a-2960-43fd-9c8f-56326a01c9aa)
- 操作内容
	![](https://alidocs.dingtalk.com/core/api/resources/img/5eecdaf48460cde5f0589c192356a7671c70a8b201b3b05a75b8339e1c4c2483d3ee942809d4d88a39e8703ac5556d0de8bf9e7cae5e99e533ff4f11ada9343096964146eed2a69485d2dd95b9f0ce459b00583dcfebeb4b769ad1f4b6dff447?tmpCode=cfb4505a-2960-43fd-9c8f-56326a01c9aa)
- 操作记录
	![](https://alidocs.dingtalk.com/core/api/resources/img/5eecdaf48460cde5f0589c192356a7671c70a8b201b3b05a75b8339e1c4c2483d3ee942809d4d88a39e8703ac5556d0d9e25af10e69477f7f6997ec7cc91b2501d7dce8b79dcfb7b012b536cd8e1b0a7503a6416f64242a76d1e02c5c6c56097?tmpCode=cfb4505a-2960-43fd-9c8f-56326a01c9aa)
## 四、根因分析：

1. 上线时间早，公共核心服务应该晚于11点，降低影响范围
2. 恢复时间太长，定位到nacos配置的问题时间过长
3. nacos修改缺少检查机制（交叉检查）
4. nacos修改后当天未进行版本发布
5. 原nacos配置一直会进行错误提示，当真正发生错误时反而会难以注意、放松警惕。

![](https://alidocs.dingtalk.com/core/api/resources/img/5eecdaf48460cde5f0589c192356a7671c70a8b201b3b05a75b8339e1c4c2483d3ee942809d4d88a39e8703ac5556d0df701e30fefc4a29acc822ff49e217e66e78ddecf2d28e797b604304af18135997987cc87617fb6de06b3b16740be8ad0?tmpCode=bac90d62-1e0b-480e-a1b3-d8ac85626a3b)

## 五、如何避免：

1. 核心配置不要放入nacos中配置，避免误操作的可能
2. 使用 [https://www.jq22.com/textDifference](https://www.jq22.com/textDifference)文本对比工具，关注下改动点
3. nacos配置格式问题优化
4. 修改nacos时切记慎重，需代码CR一样进行交叉检查。
5. 优化admin健康检查逻辑，检查失败，老节点不下线。
6. 快速重启机制（admin崩溃后，无法进入发布平台）
7. nacos配置修改增加审批流
8. nacos配置根据功能拆分，不要过重将所有配置放到单一配置文件中
9. 关键系统核心服务变更需服务侧负责人@梁强(破天)(梁强)检查审批