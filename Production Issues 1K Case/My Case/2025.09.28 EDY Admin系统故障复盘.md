# 一、问题及影响范围：
## 问题
（1） [#274688 客服工作台卡死](https://ones.edianzu.cn/project/#/team/FkhuaHWU/project/C4H8kcDJQeeGfuVv/component/qSy2kWTP/task/Jt2mE2ycRH5SrnNa)
（2）业务群反馈
![image.png](https://atlantis-picgo-core.oss-cn-beijing.aliyuncs.com/picgo/20251010111032-607caa-20251010111031825.png)


（3）业务群反馈
![image.png](https://atlantis-picgo-core.oss-cn-beijing.aliyuncs.com/picgo/20251010110929-711ae2-20251010110928990.png)
## 影响范围：
admin服务的`https://adminnew.edianzu.cn/api/site/checkLoginByToken?ssId=15e1359222a6d8b9cf2de517a33b67f3`接口报错，导致admin登陆后身份认证失败。所有接入admin的系统均受影响

# 二、时间线：
2025年9月28日：
1. admin代码上线（22:14 群里反馈admin登陆问题）
2. 怀疑28日的代码变更存在bug，@梁强(破天)(梁强)立即回滚当晚上线的代码（22:16）。
3. 回滚后发现问题依然没有得到解决。（22:24）
4. 根据报错发现数据库格式问题，经查找，定位通过数据库连接增加`zeroDateTimeBehavior=convertToNull`（22:28）
5. 定位nacos，发现nacos中数据连接配置问题（22:30）。
6. 更改nacos配置，重启上线（22：38 admin恢复正常）
# 三、问题原因：

## nacos配置错误导致（数据库连接配置多打了个换行符）
- 报错提示  
  ![image.png](https://atlantis-picgo-core.oss-cn-beijing.aliyuncs.com/picgo/20251010110207-5d9f63-20251010110206931.png)
  ![image.png](https://atlantis-picgo-core.oss-cn-beijing.aliyuncs.com/picgo/20251010110312-9aa887-20251010110312025.png)
- 操作内容	
  ![image.png](https://atlantis-picgo-core.oss-cn-beijing.aliyuncs.com/picgo/20251010110401-222cbf-20251010110400603.png)
- 操作记录
  ![image.png](https://atlantis-picgo-core.oss-cn-beijing.aliyuncs.com/picgo/20251010110415-81581c-20251010110414721.png)

# 四、根因分析：
1. 上线时间早，公共核心服务应该晚于11点，降低影响范围
2. 恢复时间太长，定位到nacos配置的问题时间过长
3. nacos修改缺少检查机制（交叉检查）
4. nacos修改后当天未进行版本发布
5. 原nacos配置一直会进行错误提示，当真正发生错误时反而会难以注意、放松警惕。
![image.png](https://atlantis-picgo-core.oss-cn-beijing.aliyuncs.com/picgo/20251010110427-1b533d-20251010110427392.png)
# 五、如何避免：
1. 核心配置不要放入nacos中配置，避免误操作的可能
2. 使用 [https://www.jq22.com/textDifference](https://www.jq22.com/textDifference)文本对比工具，关注下改动点
3. nacos配置格式问题优化
4. 修改nacos时切记慎重，需代码CR一样进行交叉检查。
5. 优化admin健康检查逻辑，检查失败，老节点不下线。
6. 快速重启机制（admin崩溃后，无法进入发布平台）
7. nacos配置修改增加审批流
8. nacos配置根据功能拆分，不要过重将所有配置放到单一配置文件中
9. 关键系统核心服务变更需服务侧负责人@梁强(破天)(梁强)检查审批

> 切记nacos非上线时间不可🙅修改，@RefreshScope 或者 配置中的 refresh-enabled: true 开关均会立刻使配置变更生效