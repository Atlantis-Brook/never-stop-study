#Spring #Transactional
**ä¸ºä»€ä¹ˆ @Transactional ä¼šå¯¼è‡´å¤šæ•°æ®æº @DS å¤±æ•ˆï¼Ÿä¸ºä»€ä¹ˆä¸¤ä¸ªæ•°æ®æºæœ‰ç›¸åŒè¡¨ç»“æ„æ—¶æ›´å®¹æ˜“è¸©å‘ï¼Ÿå¦‚ä½•æ­£ç¡®è§£å†³ï¼Ÿ**

---

# ğŸ¯ å…³é”®ç»“è®ºï¼ˆå…ˆå‘Šè¯‰ä½ ç­”æ¡ˆï¼‰

> **åœ¨ä½¿ç”¨ dynamic-datasource æ—¶ï¼Œ`@Transactional` é»˜è®¤åªç»‘å®šåˆ°â€œä¸»æ•°æ®æºâ€**  
> è¿™ä¼šå¯¼è‡´ï¼š
> 
> - `@DS` **å¤±æ•ˆ**
>     
> - SQL å…¨éƒ¨è½åˆ°ä¸€ä¸ªæ•°æ®æº
>     
> - å°¤å…¶åœ¨ä¸¤ä¸ªåº“â€œè¡¨ç»“æ„ä¸€è‡´â€æ—¶æ›´æ— æ„Ÿï¼Œå®¹æ˜“è¯¯ä»¥ä¸ºæ­£å¸¸
>     

**åŸå› ï¼šäº‹åŠ¡ AOP çš„åˆ‡é¢æ‰§è¡Œé¡ºåºé«˜äºæ•°æ®æºè·¯ç”±åˆ‡é¢ï¼Œå¯¼è‡´ DS ä¸èƒ½ç”Ÿæ•ˆã€‚**

è§£å†³æ–¹æ¡ˆè§åé¢ã€‚

---

# ğŸ§¨ ä¸ºä»€ä¹ˆ @Transactional ä¼šå¯¼è‡´ @DS å¤±æ•ˆï¼Ÿ

## 1ï¼‰Spring äº‹åŠ¡æ³¨è§£ä¼˜å…ˆçº§æ¯” @DS é«˜ï¼ˆé‡è¦ï¼ï¼‰

Spring çš„åˆ‡é¢æ‰§è¡Œé¡ºåºï¼š

|åˆ‡é¢|æ‰§è¡Œå…ˆå|
|---|---|
|**äº‹åŠ¡åˆ‡é¢ï¼ˆ@Transactionalï¼‰**|**å…ˆæ‰§è¡Œ**|
|æ•°æ®æºåˆ‡é¢ï¼ˆDSDynamicDataSourceAspectï¼‰|åæ‰§è¡Œ|

ä¹Ÿå°±æ˜¯è¯´ï¼š

### å½“è¿›å…¥ä¸€ä¸ª `@Transactional` æ–¹æ³•æ—¶ï¼š

- Spring **å·²ç»å†³å®šä½¿ç”¨å“ªä¸ªæ•°æ®æºçš„äº‹åŠ¡ç®¡ç†å™¨**
    
- äº‹åŠ¡å¼€å§‹å `@DS` æ‰æ‰§è¡Œï¼Œè¿™æ—¶å€™åˆ‡æ¢æ•°æ®æºå·²ç» **æ¥ä¸åŠäº†**
    
- å› ä¸ºï¼šä¸€ä¸ªäº‹åŠ¡åªèƒ½ç»‘å®šåˆ° 1 ä¸ª DataSource
    

å› æ­¤ï¼š

> **æœ‰äº‹åŠ¡æ—¶ï¼Œæ•°æ®æºç”±äº‹åŠ¡ç®¡ç†å™¨å†³å®šï¼Œä¸ç”± @DS å†³å®šã€‚**

---

# ğŸŒ‹ ä¸ºä»€ä¹ˆâ€œä¸¤ä¸ªæ•°æ®æºè¡¨ç»“æ„ä¸€æ ·â€æ—¶æ›´å®¹æ˜“è¯¯åˆ¤ï¼Ÿ

å› ä¸ºä½ çœ‹ä¸å‡ºæ¥å®ƒå…¶å®æ ¹æœ¬æ²¡æœ‰åˆ‡æ¢æ•°æ®æºï¼Œä¾‹å¦‚ï¼š

- archery åº“å’Œ default åº“éƒ½æœ‰è¡¨ï¼š`t_user`
    
- ç”±äºäº‹åŠ¡ç»‘å®šåˆ°äº† default
    
- æ‰€æœ‰æŸ¥è¯¢éƒ½è·‘ default
    
- ç»“æœç…§æ ·æŸ¥å‡ºæ¥ï¼Œä¸æŠ¥é”™
    

ä½ ä¼šè¯¯ä»¥ä¸ºï¼š

> â€œ@DS æ­£å¸¸å·¥ä½œâ€

å®é™…æ ¹æœ¬æ²¡åˆ‡ï¼

---

# ğŸ” å¤ç°ç°è±¡ï¼ˆä½ è‚¯å®šé‡åˆ°è¿‡ï¼‰

```java
@Service
public class MyService {

    @DS("archery")
    @Transactional
    public void queryArchery() {
        archeryMapper.selectById(1); // âŒ å®é™…æŸ¥è¯¢çš„æ˜¯ default
    }
}
```

ç»“æœï¼š**æŸ¥çš„ä¸æ˜¯ archeryï¼Œè€Œæ˜¯é»˜è®¤æ•°æ®æº**

å¦‚æœ archery å’Œ default ç»“æ„ç›¸åŒ â†’ ä½ æ ¹æœ¬å¯Ÿè§‰ä¸åˆ°ã€‚

---

# ğŸš€ æ­£ç¡®è§£å†³æ–¹å¼ï¼ˆæŒ‰ä¼˜å…ˆçº§æ¨èï¼‰

---

## âœ… **æ–¹æ¡ˆ 1ï¼šäº‹åŠ¡ä¹Ÿä½¿ç”¨åŠ¨æ€æ•°æ®æºç®¡ç†å™¨ï¼ˆæ¨èï¼‰**

ä½¿ç”¨ dynamic-datasource æä¾›çš„ **DynamicDataSourceTransactionManager**

ä½ éœ€è¦è®©äº‹åŠ¡ç®¡ç†å™¨æ”¯æŒå¤šæ•°æ®æºï¼Œå¦åˆ™ Spring é»˜è®¤ä½¿ç”¨ä¸»æ•°æ®æºäº‹åŠ¡ç®¡ç†å™¨ã€‚

**å¦‚æœä½ ç”¨çš„æ˜¯ starterï¼š**

```yaml
spring:
  datasource:
    dynamic:
      primary: default
      strict: false
      datasource:
        default:
          url: ...
        archery:
          url: ...
```

å®ƒä¼šè‡ªåŠ¨å¯ç”¨ `DynamicDataSourceTransactionManager`  
â†’ **@Transactional å°†è‡ªåŠ¨è·Ÿéš @DS åˆ‡æ¢æ•°æ®æº**  
â†’ ä¸ä¼šå†å¤±æ•ˆ

ğŸ“Œ **å‰æï¼šä¸è¦è‡ªå·±å®šä¹‰ DataSourceTransactionManagerï¼**

---

## âœ… **æ–¹æ¡ˆ 2ï¼šç»™æ–¹æ³•åŠ  @DSTransactionalï¼ˆå®˜æ–¹æä¾›ï¼‰**

åŠ¨æ€æ•°æ®æºæä¾›äº†ä¸€ä¸ªæ›¿ä»£æ–¹æ¡ˆï¼š

```java
@DSTransactional
@DS("archery")
public void test(){}
```

ç‰¹ç‚¹ï¼š

- äº‹åŠ¡å’Œæ•°æ®æºç»‘å®šåœ¨ä¸€èµ·
    
- æ­£ç¡®åœ°å…ˆå†³å®šæ•°æ®æºï¼Œå†å¼€å¯äº‹åŠ¡
    

---

## â›” é”™è¯¯æ–¹å¼ï¼šæŠŠ @Transactional æ”¾åœ¨ Service ç±»ä¸Š

æ¯”å¦‚ï¼š

```java
@Service
@Transactional
public class MyService { ... }
```

è¿™æ ·ï¼š

- æ‰€æœ‰æ–¹æ³•å…±äº«åŒä¸€ä¸ªæ•°æ®æºäº‹åŠ¡ç®¡ç†å™¨ï¼ˆé€šå¸¸æ˜¯ä¸»åº“ï¼‰
    
- @DS æ ¹æœ¬æ— æ³•ç”Ÿæ•ˆ
    

---

# ğŸ¯ å»ºè®®ä½ æŒ‰å¦‚ä¸‹è§„åˆ™ä½¿ç”¨

|åœºæ™¯|ç”¨æ³•|
|---|---|
|å•ä¸ªæ–¹æ³•åˆ‡æ¢æ•°æ®æºå¹¶éœ€è¦äº‹åŠ¡|ç”¨ `@DSTransactional` + `@DS`|
|æ•´ä¸ª service è¯»å†™éƒ½å±äºæŸä¸ªæ•°æ®æº|åœ¨ Service ç±»ä¸Šç”¨ `@DS`ï¼Œæ–¹æ³•ä¸Šç”¨ `@Transactional`|
|æœ‰å¤šä¸ªæ•°æ®æºå¹¶å¸¦äº‹åŠ¡|ç¡®ä¿ä½¿ç”¨ DynamicDataSourceTransactionManager|

---

# ğŸ§ª å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ æ£€æŸ¥ä½ çš„é…ç½®

å¦‚æœä½ æŠŠä½ çš„ï¼š

- `application.yml`ï¼ˆåŠ¨æ€æ•°æ®æºéƒ¨åˆ†ï¼‰
    
- è‡ªå·±æœ‰æ²¡æœ‰å£°æ˜äº‹åŠ¡ç®¡ç†å™¨çš„é…ç½®ç±»
    
- ä½ ä½¿ç”¨çš„ @DS + @Transactional ä»£ç ç¤ºä¾‹
    

å‘å‡ºæ¥ï¼Œæˆ‘å¯ä»¥å‘Šè¯‰ä½  **åˆ°åº•æ˜¯ä¸æ˜¯å› ä¸ºäº‹åŠ¡ç®¡ç†å™¨é…ç½®é”™è¯¯å¯¼è‡´çš„**ï¼ˆ90% çš„å…¬å¸éƒ½ä¼šé…é”™ï¼‰ã€‚